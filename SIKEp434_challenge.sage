import public_values_aux
from public_values_aux import *
import hashlib

set_verbose(-1)
load('castryck_decru_shortcut.sage')
load('sandwich_attack.sage')

SIKE_parameters = {
    "SIKEp434" : (216, 137),
    "SIKEp503" : (250, 159),
    "SIKEp610" : (305, 192),
    "SIKEp751" : (372, 239),
    "SIKEp964" : (486, 301), # removed after NIST round 1
}

# Change me to attack different parameter sets
NIST_submission = "SIKEp434"
a, b = SIKE_parameters[NIST_submission]

print(f"Running the attack against {NIST_submission} parameters, which has a prime: 2^{a}*3^{b} - 1")

print(f"Generating public data for the attack...")
# Set the prime, finite fields and starting curve
# with known endomorphism
p = 2^a*3^b - 1
public_values_aux.p = p

Fp2.<i> = GF(p^2, modulus=x^2+1)
assert i^2 == -1
R.<x> = PolynomialRing(Fp2)

E_start = EllipticCurve(Fp2, [0,6,0,1,0])
E_start.set_order((p+1)^2, num_checks=0) # Speeds things up in Sage

# Generation of the endomorphism 2i
two_i = generate_distortion_map(E_start)

# $IKEp434 public parameters

xQ2 = 8633131302536015373065425580178973814526244742660764898957635611033517358603093513483897324469034427019598357249425684820405193836 + i*1640555213321637736080614728970921962714590288563692816952785470842808462670732196555713644986698688787353020078064569199240185333
yQ2 = 20276452752220665548202189403598170750834982427130760850813254160550305310659929663123304778814287531500756146204805251963783256037 + i*10045306525245350298803819046509877432229480969314772374869175643233206473596453796721101344057683381390923103776706006170651177942
Q2 = E_start(xQ2, yQ2)

xP2 = 2634539327592482918121599540115765431217195093350648632832477775508933673747596362667240890051240463853167541162279343167040310088 + i*18590308952679468489364793668589003541299106140709579196186461020066893645141198854487503147226318730158493210982567772716162869840
yP2 = 18499992072774772182750461054948965122862326576938683155863157755664308576685791546530637605543615310883354355922717114976263189216 + i*10983718925653566249610333622918370357192097441961014913751641775508865561311331364566791542776619041356373750734992554370506677551
P2 = E_start(xP2, yP2)

# # CONSISTENCY WITH R (NOT NEEDED BUT OK)
# XR2 = 10548244869191429978994573331033429460802791853191679921432716242390096998215982561051229194803656270150791181542353263212179039510 + i*17623338845092751517427595119320347017334966146230013113905734683582704966390296970846105400364294574370981828797535336936167097772
# assert (P2 - Q2)[0] == xR2

xQ3 = 13106015910647201458426811493288965923311702902321179794984306791335898269651901670809619116119997952683697617529379507339288983622 + i*0
yQ3 = 0 + i*10209775938515962501771741506081580425243588708606392462054462399651871393790372518908435424495021346995173633235373991504988757970
Q3 = E_start(xQ3, yQ3)

xP3 = 5822289030790821842647204127346110197186614331916510409554480418611145246532692679762948023941031185216358707524703325193156147113 + i*0
yP3 = 4631002038627486062145710538859886699092897850004224163519174820337269208909673679867855016325656365561668068341925816094377133115 + i*0
P3 = E_start(xP3, yP3)

# # CONSISTENCY WITH R (NOT NEEDED BUT OK)
# # Typo in magma, should be P3 and Q3
# xR3 = 19978714732817982296321998790126652405475699311529669091328949981490769847281914491438519436155586335833863255694913096932863948652 + i*14167827257511306746606440016400170231086622175754382579855491498256779752299521404090563911050166061448571907478184141518856743652
# assert (P3 - Q3)[0] == xR3

# Curve isogeny system "SIDHp434". Base curve: Montgomery curve By^2 = Cx^3 + Ax^2 + Cx defined over GF(p434^2), where A=6, B=1, C=1 and p434 = 2^216*3^137-1

# BOB'S PUBLIC KEY:

# challenge
xPB = 20648630945288875895543631892994042382468428865686818676390481141407070182341828883288180646457486918619949217867858294626861534175 + i * 7241507110606646585814615724269455050671965086273890121488296367344649592019089509293512287506505961438489163984183048554524445177
xQB = 5984770474013541647074824123582552527142702827775518051119219875288895351023018008192421851402725912456828396700943060384651702384 + i * 578644568857744686591928087314403964664806861847276792436523806903077807322095036537673556147556428320152382324190658718235920171
xRB = 16476712615638590366320952765153169972919821954793203742870963905179874505555572071685431005888045559348952324911698539477624609757 + i * 9629745550486482583422035276247659527144888434282679463170379307267488821902602083895745462292248669658520717106515223215336002651

B = (1 - xPB*xQB - xPB*xRB - xQB*xRB)^2/(4*xPB*xQB*xRB) - xPB - xQB - xRB

yPB = sqrt(xPB^3 + B*xPB^2 + xPB)

yQB = sqrt(xQB^3 + B*xQB^2 + xQB)

# SMALL ERROR IN SIDH-spec.pdf, CORRECTED HERE
if xRB + xQB + xPB + B != (yQB + yPB)^2 / (xQB - xPB)^2:
    yQB = -yQB

# let's check:
EB = EllipticCurve(Fp2, [0,B,0,1,0])
EB.set_order((p+1)^2, num_checks=0) # Speeds things up in Sage

PB = EB(xPB, yPB)
QB = EB(xQB, yQB)

# ===================================
# =====  ATTACK  ====================
# ===================================

def RunAttack(num_cores):
    return CastryckDecruAttack(E_start, P2, Q2, EB, PB, QB, two_i, num_cores=num_cores)

if __name__ == '__main__' and '__file__' in globals():
    if '--parallel' in sys.argv:
        # Set number of cores for parallel computation
        num_cores = os.cpu_count()
        print(f"Performing the attack in parallel using {num_cores} cores")
    else:
        num_cores = 1

    if '--sandwich' in sys.argv:
        # Use the fact that 2^(a-1) - 5*3^b is a sum of squares
        assert two_squares(2^(a-1) - 5*3^b)
        recovered_key = SandwichAttack(E_start, P2, Q2, EB, PB, QB, two_i, k=5, alp=1)
    else:
        out_Bob = RunAttack(num_cores)
        print(out_Bob)
        out_Bob = hashlib.sha3_512(str(out_Bob).encode())
        print("\nSHA3-512 hash of Bob's shared secret - SHA3-512:\n")
        print(out_Bob.hexdigest())

